{% extends "base.html" %}

{% block title %}Gestion de Production - Dersa EcoQuality{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h3 mb-4">
            <i class="fas fa-cogs text-primary"></i> 
            Gestion des Lots de Production
        </h1>
    </div>
</div>

<!-- Add New Batch -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-plus"></i> Créer un Nouveau Lot de Production
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('production') }}">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="batch_number" class="form-label">Numéro de Lot *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="batch_number" name="batch_number" required placeholder="LOT-2025-001">
                                    <button type="button" class="btn btn-outline-secondary" onclick="generateLotNumber()" title="Générer un numéro unique">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="product_type" class="form-label">Type de Produit *</label>
                                <select class="form-select" id="product_type" name="product_type" required>
                                    <option value="">Sélectionner le Type de Produit</option>
                                    <option value="floor_tiles">Carreaux de Sol</option>
                                    <option value="wall_tiles">Carreaux Muraux</option>
                                    <option value="gres_cerame">Grès Cérame</option>
                                    <option value="porcelain_tiles">Carreaux en Porcelaine</option>
                                    <option value="rectified_tiles">Carreaux Rectifiés</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="production_date" class="form-label">Date de Production *</label>
                                <input type="date" class="form-control" id="production_date" name="production_date" required value="{{ today }}">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="planned_quantity" class="form-label">Quantité Prévue *</label>
                                <input type="number" class="form-control" id="planned_quantity" name="planned_quantity" required min="1" placeholder="ex: 1000">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="kiln_number" class="form-label">N° Four</label>
                                <input type="text" class="form-control" id="kiln_number" name="kiln_number" placeholder="ex: FOUR-01">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="firing_temperature" class="form-label">Température de Cuisson (°C)</label>
                                <input type="number" step="0.1" class="form-control" id="firing_temperature" name="firing_temperature" min="800" max="1400" placeholder="ex: 1200">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="firing_duration" class="form-label">Durée de Cuisson</label>
                                <input type="text" class="form-control" id="firing_duration" name="firing_duration" placeholder="ex: 18 heures">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="notes" class="form-label">Notes</label>
                                <input type="text" class="form-control" id="notes" name="notes">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        <i class="fas fa-save"></i> Créer le Lot
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="filter_status" class="form-label">Status</label>
                        <select class="form-select" id="filter_status" name="status">
                            <option value="">All Statuses</option>
                            <option value="planned" {{ 'selected' if request.args.get('status') == 'planned' }}>Planned</option>
                            <option value="in_progress" {{ 'selected' if request.args.get('status') == 'in_progress' }}>In Progress</option>
                            <option value="completed" {{ 'selected' if request.args.get('status') == 'completed' }}>Completed</option>
                            <option value="approved" {{ 'selected' if request.args.get('status') == 'approved' }}>Approved</option>
                            <option value="rejected" {{ 'selected' if request.args.get('status') == 'rejected' }}>Rejected</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filter_date_from" class="form-label">Date From</label>
                        <input type="date" class="form-control" id="filter_date_from" name="date_from" value="{{ request.args.get('date_from', '') }}">
                    </div>
                    <div class="col-md-3">
                        <label for="filter_date_to" class="form-label">Date To</label>
                        <input type="date" class="form-control" id="filter_date_to" name="date_to" value="{{ request.args.get('date_to', '') }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <a href="{{ url_for('production') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Clear
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Production Batches Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list"></i> Production Batches
                    <span class="badge bg-secondary ms-2">{{ batches|length }} batches</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Batch Number</th>
                                <th>Product Type</th>
                                <th>Production Date</th>
                                <th>Quantity</th>
                                <th>Kiln</th>
                                <th>Temperature</th>
                                <th>Status</th>
                                <th>Supervisor</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for batch in batches %}
                            <tr>
                                <td>
                                    <strong>{{ batch.batch_number }}</strong>
                                </td>
                                <td>{{ batch.product_type.replace('_', ' ').title() }}</td>
                                <td>{{ batch.production_date }}</td>
                                <td>
                                    {{ batch.actual_quantity or batch.planned_quantity }}
                                    {% if batch.actual_quantity and batch.planned_quantity %}
                                        <small class="text-muted">/ {{ batch.planned_quantity }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ batch.kiln_number or '-' }}</td>
                                <td>{{ batch.firing_temperature or '-' }}°C</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if batch.status == 'approved' else 'primary' if batch.status == 'in_progress' else 'warning' if batch.status == 'completed' else 'danger' if batch.status == 'rejected' else 'secondary' }}">
                                        {{ batch.status.replace('_', ' ').title() }}
                                    </span>
                                </td>
                                <td>{{ batch.supervisor_name or '-' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('quality') }}?batch_id={{ batch.id }}" class="btn btn-outline-success" title="Quality Tests">
                                            <i class="fas fa-check"></i>
                                        </a>
                                        <button class="btn btn-outline-primary" onclick="editBatch('{{ batch.id }}')" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">
                                    No production batches found. Create your first batch above.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Set today's date as default
document.getElementById('production_date').value = new Date().toISOString().split('T')[0];

// Generate unique lot number
async function generateLotNumber() {
    const btn = document.querySelector('button[onclick="generateLotNumber()"]');
    const input = document.getElementById('batch_number');
    
    // Show loading state
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;
    
    try {
        // Get current date for format
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        
        // Try different patterns until we find a unique one
        let attempts = 0;
        let lotNumber = '';
        let isUnique = false;
        
        while (!isUnique && attempts < 50) {
            attempts++;
            const sequence = String(attempts).padStart(3, '0');
            lotNumber = `LOT-${year}${month}${day}-${sequence}`;
            
            // Check if this number exists
            const response = await fetch(`/api/check-lot-number?number=${encodeURIComponent(lotNumber)}`);
            const data = await response.json();
            isUnique = !data.exists;
        }
        
        if (isUnique) {
            input.value = lotNumber;
            input.focus();
            // Flash success
            input.classList.add('is-valid');
            setTimeout(() => input.classList.remove('is-valid'), 2000);
        } else {
            throw new Error('Unable to generate unique lot number');
        }
        
    } catch (error) {
        console.error('Error generating lot number:', error);
        alert('Erreur lors de la génération du numéro de lot. Veuillez essayer manuellement.');
    } finally {
        // Restore button
        btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
        btn.disabled = false;
    }
}

function editBatch(batchId) {
    alert('Edit functionality will be implemented in the next version.');
}

// Auto-generate lot number on page load if field is empty
document.addEventListener('DOMContentLoaded', function() {
    const batchInput = document.getElementById('batch_number');
    if (!batchInput.value.trim()) {
        generateLotNumber();
    }
    
    // Add comprehensive form submission debugging
    const form = document.querySelector('form[method="POST"]');
    const submitBtn = document.getElementById('submit-btn');
    
    if (form && submitBtn) {
        console.log('🔧 Form debugging setup activated');
        console.log('Form action:', form.action);
        console.log('Form method:', form.method);
        
        form.addEventListener('submit', function(e) {
            console.log('🚀 FORM SUBMISSION ATTEMPTED');
            console.log('Event:', e);
            
            // Log all form data
            const formData = new FormData(form);
            console.log('📋 FORM DATA:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: "${value}"`);
            }
            
            // Check required fields
            const requiredFields = ['batch_number', 'product_type', 'production_date', 'planned_quantity'];
            let allValid = true;
            let missingFields = [];
            
            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                const value = field ? field.value.trim() : '';
                console.log(`🔍 Checking ${fieldName}: "${value}" (${value ? 'OK' : 'MISSING'})`);
                
                if (!field || !value) {
                    console.error(`❌ Missing required field: ${fieldName}`);
                    missingFields.push(fieldName);
                    allValid = false;
                    if (field) {
                        field.classList.add('is-invalid');
                    }
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!allValid) {
                console.error(`❌ FORM VALIDATION FAILED - Missing fields: ${missingFields.join(', ')}`);
                e.preventDefault();
                alert(`Veuillez remplir tous les champs obligatoires: ${missingFields.join(', ')}`);
                return false;
            }
            
            console.log('✅ All validation passed - Form will submit');
            
            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Création en cours...';
            submitBtn.disabled = true;
            
            // Allow form to proceed
            return true;
        });
        
        // Debug button click
        submitBtn.addEventListener('click', function(e) {
            console.log('🖱️ Submit button clicked');
            console.log('Button type:', submitBtn.type);
            console.log('Button disabled:', submitBtn.disabled);
        });
    } else {
        console.error('❌ Form or submit button not found!');
        console.log('Form:', form);
        console.log('Submit button:', submitBtn);
    }
});
</script>
{% endblock %}